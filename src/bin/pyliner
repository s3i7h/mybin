#!/usr/bin/env bash

file=$(mktemp)
io=false
dry=false

while true; do
    case "$1" in
        "-h" | "--header" )
            shift
            header="$1"
            shift
            echo "$header" >> $file
            ;;
        "-i" | "--io" )
            shift
            io=true
            ;;
        "-n" | "--dry-run" )
            shift
            dry=true
            ;;
        *)
            break
            ;;
    esac
done


script=$(echo -n "$@")

cat <<EOF >> $file
import sys, os, shutil, re

EOF

if $io; then
    cat << EOF >> $file
stdin, stdout = sys.stdin, sys.stdout

${script:-"for chunk in stdin.buffer: stdout.buffer.write(chunk)"}
EOF
else
    cat << EOF >> $file
for i, line in enumerate(sys.stdin):
    line, eol, *__unused = *re.split("(\r?\n)", line), ''
    print(${script:-line}, end=eol)
EOF
fi

if $dry; then
    cat $file
else
    python $file
fi
rm $file
